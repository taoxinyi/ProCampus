{% extends 'website/frontend/frontend_base_nosearch.html' %}
{% load staticfiles %}

{% block external_header %}
{% endblock %}
{% block left %}
    <style type="text/css">
        .parent {
            display: flex;
            height: 40px;
            margin: 10px;
        }

        .l-child {
            flex: 0 0 40px;
        }

        .r-child {
            padding-left: 10px;
            margin: auto 10px;
        }
    </style>
    <head>
        <style>
            /* bubble style */
            .left {
                clear: both;

            }

            .left div:nth-of-type(1) {
                float: left;
            }

            .left div:nth-of-type(2) {
                background-color: aquamarine;
                float: left;
                margin: 20px 20px 10px 15px;
                padding: 10px;
                border-radius: 7px;
            }

            .right div:first-child img,
            .left div:first-child img {
                width: 60px;
                height: 60px;
            }

            .right {
                clear: both;
            }

            .right div:nth-child(1) {
                float: right;
            }

            .right div:nth-of-type(2) {
                float: right;
                background-color: gold;
                margin: 20px 10px 10px 20px;
                padding: 10px;
                border-radius: 7px;
            }

            .left_triangle {
                height: 0px;
                width: 0px;
                border-width: 8px;
                border-style: solid;
                border-color: transparent aquamarine transparent transparent;
                position: absolute;
                left: -15px;
                top: 8px;
            }

            .box {
                position: relative;
            }

            .right_triangle {
                height: 0px;
                width: 0px;
                border-width: 8px;
                border-style: solid;
                border-color: transparent transparent transparent gold;
                position: absolute;
                right: -15px;
                top: 8px;
            }

            .floattext {
                position: absolute;
                top: -20px;
                white-space: nowrap;
            }

            span {
                max-width: 100px;
                display: block;
                text-align: left;
                word-wrap: break-word;
            }
        </style>
    </head>
    <body>
    <div style="height: 100%;">
        <div id="chat"
             style="border: 1px solid black;width: 90% ; height: 600px; overflow-y: scroll;margin: 10px auto;"></div>
        <div style="width: 40% ;margin: 10px auto;"><input id="chat-message-input" type="text"
                                                           align="center" style="width: 80% ;"/><input
                id="chat-message-submit" type="button" value="Send"/>
            <br/>
        </div>
    </div>
    </body>
{% endblock %}

{% block right %}
    <div id="online_list">online user list</div>
{% endblock %}
{% block front_js %}
    <script>

        //set root name
        var roomName = {{ room_name_json }};
        //establish WebSocket based on this specifc room name
        var chatSocket = new WebSocket(
            'ws://' + window.location.host +
            '/ws/chat/' + roomName + '/');
        //When the WebSocket received message
        chatSocket.onmessage = function (e) {
            var d = e.data;
            var arrayBuffer;
            var fileReader = new FileReader();
            fileReader.onload = function () {
                //when load as array buffer succeed
                arrayBuffer = this.result;
                //turn this buffer as uint8 array buffer
                var uint8Array = new Uint8Array(arrayBuffer);
                //load protobuf.js to decode
                protobuf.load("{% static "chat_message.proto" %}", function (err, root) {
                    if (err)
                        throw err;
                    var chatMessage = root.lookupType("chat.ChatMessage");
                    //decode it to object
                    var chatMessageDecoded = chatMessage.decode(uint8Array);
                    var type = chatMessageDecoded.type;
                    //Somehow the first character of protobuf class name is converted to lower case.
                    var l = chatMessageDecoded.chatMessageItem;
                    if (type === 0) {//CHAT_MESSAGE
                        if (chatMessageDecoded.currentClient.length !== 0) {//add current user list
                            var cl = chatMessageDecoded.currentClient;
                            for (var i = 0; i < cl.length; i++) {
                                addToList(cl[i].clientName, cl[i].clientId, cl[i].imageUrl);

                            }

                        }
                        for (i = 0; i < l.length; i++) {//add chat message
                            var isAuthor = l[i].clientId ==={{ user.id }};
                            addToChat(l[i].clientName, l[i].clientId, l[i].imageUrl, l[i].message, "", isAuthor);

                        }
                    } else if (type === 1) {
                        l = chatMessageDecoded.chatMessageItem[0];
                        var p = document.createElement("p");
                        p.innerText = l.clientName + " enters this room";
                        p.style.marginTop = "70px";
                        p.style.textAlign = "center";
                        document.getElementById("chat").appendChild(p);
                        addToList(l.clientName, l.clientId, l.imageUrl);

                    } else if (type === 2) {
                        l = chatMessageDecoded.chatMessageItem[0];
                        p = document.createElement("p");
                        p.innerText = l.clientName + " has left this room";
                        p.style.marginTop = "70px";
                        p.style.textAlign = "center";
                        document.getElementById("chat").appendChild(p);
                        deleteFromList(l.clientId);

                    }
                });

            };
            //read binary data (BLob) as array buffer
            fileReader.readAsArrayBuffer(d);


        };
        chatSocket.onclose = function (e) {
            console.error('Chat socket closed unexpectedly');
        };
        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function (e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };
        //submit
        document.querySelector('#chat-message-submit').onclick = function (e) {
            var messageInputDom = document.querySelector('#chat-message-input');
            var m = messageInputDom.value;
            var id ={{ user.id }};
            protobuf.load("{% static "chat_message.proto" %}", function (err, root) {
                if (err)
                    throw err;
                var chatMessage = root.lookupType("chat.ChatMessageItem");
                //Somehow the first character of protobuf class name is converted to lower case.
                //default type is 0, no need to write.
                var payload = {clientId: id, message: m};
                var message = chatMessage.create(payload);
                var buffer = chatMessage.encode(message).finish();
                chatSocket.send(buffer);

            });
            messageInputDom.value = '';
        };

        function addToChat(author, author_id, imageUrl, text, time, isAuthor) {

            var a = document.createElement("a");
            a.href = "/forum/question/user/" + author_id + "/list/";
            var img = new Image();
            img.src = imageUrl;
            a.appendChild(img);
            var div_outside = document.createElement("div");
            div_outside.style.padding = "10px";
            var div_img = document.createElement("div");
            if (author_id !== 0)
                div_img.appendChild(a);
            else
                div_img.appendChild(img);

            var div_box = document.createElement("div");
            div_box.className = "box";

            var span_text = document.createElement("span");
            span_text.innerHTML = text;

            var p = document.createElement("p");
            p.className = "floattext";
            p.innerHTML = author;
            div_box.appendChild(p);

            if (isAuthor === false) {
                var div_left = document.createElement("div");
                div_left.className = "left";
                var div_left_tri = document.createElement("div");
                div_left_tri.className = "left_triangle";
                div_box.appendChild(div_left_tri);
                div_box.appendChild(span_text);
                p.style.left = "0";
                div_left.appendChild(div_img);
                div_left.appendChild(div_box);
                div_outside.appendChild(div_left)

            }
            else {
                var div_right = document.createElement("div");
                div_right.className = "right";
                var div_right_tri = document.createElement("div");
                div_right_tri.className = "right_triangle";
                p.style.right = "5px";
                div_box.appendChild(div_right_tri);
                div_box.appendChild(span_text);

                div_right.appendChild(div_img);
                div_right.appendChild(div_box);


                div_outside.appendChild(div_right);
            }
            document.getElementById("chat").appendChild(div_outside);
            var div = document.getElementById("chat");
            div.scrollTop = div.scrollHeight - div.clientHeight;

        }

        function deleteFromList(id) {
            document.getElementById(id).parentNode.removeChild(document.getElementById(id));
            var div = document.getElementById("chat");
            div.scrollTop = div.scrollHeight - div.clientHeight;
        }

        function addToList(name, id, imageUrl) {
            if (!document.getElementById(id)) {//if not exist
                var div_list = document.getElementById("online_list");
                var div_list_item = document.createElement("div");
                div_list_item.className = "parent";
                div_list_item.id = id;
                var a = document.createElement("a");
                a.href = "/forum/question/user/" + id + "/list/";
                var img = new Image();
                img.style.width = "40px";
                img.src = imageUrl;
                a.className = "l-child";
                a.appendChild(img);
                var nickname = document.createElement("div");
                nickname.innerHTML = name;
                nickname.className = "r-child";
                div_list_item.appendChild(a);
                div_list_item.appendChild(nickname);
                div_list.appendChild(div_list_item);
                var div = document.getElementById("chat");
                div.scrollTop = div.scrollHeight - div.clientHeight;
            }
        }
    </script>

{% endblock %}
