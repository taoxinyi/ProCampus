{% extends 'website/frontend/frontend_base_nosearch.html' %}
{% load staticfiles %}
{% block external_header %}
{% endblock %}
{% block left %}
    <style type="text/css">
        .parent {
            display: flex;
            height: 40px;
            margin: 10px;
        }

        .l-child {
            flex: 0 0 40px;
        }

        .r-child {
            padding-left: 10px;
            margin: auto 10px;
        }
    </style>
    <head>
        <style>
            /* bubble style */
            .left {
                clear: both;

            }

            .left div:nth-of-type(1) {
                float: left;
            }

            .left div:nth-of-type(2) {
                background-color: aquamarine;
                float: left;
                margin: 20px 20px 10px 15px;
                padding: 10px;
                border-radius: 7px;
            }

            .right div:first-child img,
            .left div:first-child img {
                width: 60px;
                height: 60px;
            }

            .right {
                clear: both;
            }

            .right div:nth-child(1) {
                float: right;
            }

            .right div:nth-of-type(2) {
                float: right;
                background-color: gold;
                margin: 20px 10px 10px 20px;
                padding: 10px;
                border-radius: 7px;
            }

            .left_triangle {
                height: 0px;
                width: 0px;
                border-width: 8px;
                border-style: solid;
                border-color: transparent aquamarine transparent transparent;
                position: absolute;
                left: -15px;
                top: 8px;
            }

            .box {
                position: relative;
            }

            .right_triangle {
                height: 0px;
                width: 0px;
                border-width: 8px;
                border-style: solid;
                border-color: transparent transparent transparent gold;
                position: absolute;
                right: -15px;
                top: 8px;
            }

            .floattext {
                position: absolute;
                top: -20px;
                white-space: nowrap;
            }

            span {
                max-width: 100px;
                display: block;
                text-align: left;
                word-wrap: break-word;
            }
        </style>
    </head>
    <body>
    <div style="height: 100%;">
        <div id="chat"
             style="border: 1px solid black;width: 90% ; height: 600px; overflow-y: scroll;margin: 10px auto;"></div>
        <div style="width: 40% ;margin: 10px auto;"><input id="chat-message-input" type="text"
                                                           align="center" style="width: 80% ;"/><input
                id="chat-message-submit" type="button" value="Send"/>
            <br/>
        </div>
    </div>
    </body>
{% endblock %}

{% block right %}
    <div id="online_list">online user list</div>
{% endblock %}
{% block front_js %}
    <script>
        var roomName = {{ room_name_json }};
        var chatSocket = new WebSocket(
            'ws://' + window.location.host +
            '/ws/chat/' + roomName + '/');

        chatSocket.onmessage = function (e) {
            var data = JSON.parse(e.data);
            var type = data['type'];
            if (type === "clear") {
                var result = eval(data['message']);
                var current_list = eval(data['current_list']);
                document.getElementById("online_list").innerText = "";
                for (var i in current_list) {
                    addToList(current_list[i].name, current_list[i].id, current_list[i].image);

                }
                for (i in result) {
                    addToChat(result[i].author, result[i].author_id, result[i].image, result[i].message, result[i].time, result[i].isAuthor);
                }
            }
            else if (type === "chat_message") {
                addToChat(data['author'], data['author_id'], data['image'], data['message'], data['time'], data['isAuthor']);
            }
            else if (type === "client_enter") {
                var p = document.createElement("p");
                p.innerText = data['name'] + " enters this room";
                p.style.marginTop = "70px";
                p.style.textAlign = "center";

                document.getElementById("chat").appendChild(p);
                addToList(data['name'], data['id'], data['image']);
            } else if (type === "client_leave") {
                var p = document.createElement("p");
                p.innerText = data['name'] + " has left this room";
                p.style.marginTop = "70px";
                p.style.textAlign = "center";

                document.getElementById("chat").appendChild(p);
                deleteFromList(data['id']);
            }
            var elem = document.getElementById('chat');
            elem.scrollTop = elem.scrollHeight;
        };
        chatSocket.onclose = function (e) {
            console.error('Chat socket closed unexpectedly');
        };
        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function (e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };
        document.querySelector('#chat-message-submit').onclick = function (e) {
            var messageInputDom = document.querySelector('#chat-message-input');
            var message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInputDom.value = '';
        };

        function addToChat(author, author_id, imageUrl, text, time, isAuthor) {
            var a = document.createElement("a");
            a.href = "/forum/question/user/" + author_id + "/list/";
            var img = new Image();
            img.src = imageUrl;
            a.appendChild(img);
            var div_outside = document.createElement("div");
            div_outside.style.padding = "10px";
            var div_img = document.createElement("div");
            if (author_id !== 0)
                div_img.appendChild(a);
            else
                div_img.appendChild(img);

            var div_box = document.createElement("div");
            div_box.className = "box";

            var span_text = document.createElement("span");
            span_text.innerHTML = text;

            var p = document.createElement("p");
            p.className = "floattext";
            p.innerHTML = author;
            div_box.appendChild(p);

            if (isAuthor === "0") {
                var div_left = document.createElement("div");
                div_left.className = "left";
                var div_left_tri = document.createElement("div");
                div_left_tri.className = "left_triangle";
                div_box.appendChild(div_left_tri);
                div_box.appendChild(span_text);
                p.style.left = "0";
                div_left.appendChild(div_img);
                div_left.appendChild(div_box);
                div_outside.appendChild(div_left)

            }
            else {
                var div_right = document.createElement("div");
                div_right.className = "right";
                var div_right_tri = document.createElement("div");
                div_right_tri.className = "right_triangle";
                p.style.right = "5px";
                div_box.appendChild(div_right_tri);
                div_box.appendChild(span_text);

                div_right.appendChild(div_img);
                div_right.appendChild(div_box);


                div_outside.appendChild(div_right);
            }
            document.getElementById("chat").appendChild(div_outside);

        }

        function deleteFromList(id) {
            document.getElementById(id).parentNode.removeChild(document.getElementById(id));
        }

        function addToList(name, id, imageUrl) {
            var div_list = document.getElementById("online_list");
            var div_list_item = document.createElement("div");
            div_list_item.className = "parent";
            div_list_item.id = id;
            var a = document.createElement("a");
            a.href = "/forum/question/user/" + id + "/list/";
            var img = new Image();
            img.style.width = "40px";
            img.src = imageUrl;
            a.className = "l-child";
            a.appendChild(img);
            var nickname = document.createElement("div");
            nickname.innerHTML = name;
            nickname.className = "r-child";
            div_list_item.appendChild(a);
            div_list_item.appendChild(nickname);
            div_list.appendChild(div_list_item);
        }
    </script>

{% endblock %}
