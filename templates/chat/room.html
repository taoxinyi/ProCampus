{% extends 'website/frontend/frontend_base_nosearch.html' %}
{% load staticfiles %}
{% block external_header %}
{% endblock %}
{% block left %}
    <head>
        <style>
            /* bubble style */
            .left {
                clear: both;

            }

            .left div:nth-of-type(1) {
                float: left;
            }

            .left div:nth-of-type(2) {
                background-color: aquamarine;
                float: left;
                margin: 20px 20px 10px 15px;
                padding: 10px;
                border-radius: 7px;
            }

            .right div:first-child img,
            .left div:first-child img {
                width: 60px;
                height: 60px;
            }

            .right {
                clear: both;
            }

            .right div:nth-child(1) {
                float: right;
            }

            .right div:nth-of-type(2) {
                float: right;
                background-color: gold;
                margin: 20px 10px 10px 20px;
                padding: 10px;
                border-radius: 7px;
            }

            .left_triangle {
                height: 0px;
                width: 0px;
                border-width: 8px;
                border-style: solid;
                border-color: transparent aquamarine transparent transparent;
                position: absolute;
                left: -15px;
                top: 8px;
            }

            .box {
                position: relative;
            }

            .right_triangle {
                height: 0px;
                width: 0px;
                border-width: 8px;
                border-style: solid;
                border-color: transparent transparent transparent gold;
                position: absolute;
                right: -15px;
                top: 8px;
            }

            .floattext {
                position: absolute;
                top: -20px;
                white-space:nowrap;
            }

            span {
                max-width: 100px;
                display: block;
                text-align: left;
                word-wrap: break-word;
            }
        </style>
    </head>
    <body>
    <div style="height: 100%;">
        <div id="chat"
             style="border: 1px solid black;width: 90% ; height: 600px; overflow-y: scroll;margin: 10px auto;"></div>
        <div style="width: 40% ;margin: 10px auto;"><input id="chat-message-input" type="text"
                                                           align="center" style="width: 80% ;"/><input
                id="chat-message-submit" type="button" value="Send"/>
            <br/>
        </div>
    </div>
    </body>
    <script>
        var roomName = {{ room_name_json }};
        var chatSocket = new WebSocket(
            'ws://' + window.location.host +
            '/ws/chat/' + roomName + '/');

        chatSocket.onmessage = function (e) {
            var data = JSON.parse(e.data);
            var message = data['message'];
            var type = data['type']
            var isAuthor = data['isAuthor'];
            if (type === "clear") {
                var result = eval(data['message']);
                for (var i in result) {
                    addToChat(result[i].author, result[i].image, result[i].message, result[i].time, result[i].isAuthor);
                }
                //document.querySelector('#chat-log').value += (message);
            }
            else {
                addToChat(data['author'], data['image'], data['message'], data['time'], data['isAuthor']);
            }
            var elem = document.getElementById('chat');
            elem.scrollTop = elem.scrollHeight;
        };
        chatSocket.onclose = function (e) {
            console.error('Chat socket closed unexpectedly');
        };
        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function (e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };
        document.querySelector('#chat-message-submit').onclick = function (e) {
            var messageInputDom = document.querySelector('#chat-message-input');
            var message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInputDom.value = '';
        };

        function addToChat(author, imageUrl, text, time, isAuthor) {
            var img = new Image();
            img.src = imageUrl;
            var div_outside = document.createElement("div");
            div_outside.style.padding = "10px";
            var div_img = document.createElement("div");
            div_img.appendChild(img);

            var div_box = document.createElement("div");
            div_box.className = "box";

            var span_text = document.createElement("span");
            span_text.innerHTML = text;

            var p = document.createElement("p");
            p.className = "floattext";
            p.innerHTML = author;
            div_box.appendChild(p);

            if (isAuthor === "0") {
                var div_left = document.createElement("div");
                div_left.className = "left";
                var div_left_tri = document.createElement("div");
                div_left_tri.className = "left_triangle";
                div_box.appendChild(div_left_tri);
                div_box.appendChild(span_text);
                p.style.left = "0";
                div_left.appendChild(div_img);
                div_left.appendChild(div_box);
                div_outside.appendChild(div_left)

            }
            else {
                var div_right = document.createElement("div");
                div_right.className = "right";
                var div_right_tri = document.createElement("div");
                div_right_tri.className = "right_triangle";
                p.style.right = "5px";
                div_box.appendChild(div_right_tri);
                div_box.appendChild(span_text);

                div_right.appendChild(div_img);
                div_right.appendChild(div_box);


                div_outside.appendChild(div_right);
            }
            document.getElementById("chat").appendChild(div_outside);

        }
    </script>
{% endblock %}
{% block front_js %}
{% endblock %}